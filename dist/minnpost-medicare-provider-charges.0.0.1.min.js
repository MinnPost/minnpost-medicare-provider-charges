/*! minnpost-medicare-provider-charges - v0.0.1 - 2013-05-09
* https://github.com/MinnPost/minnpost-crime
* Copyright (c) 2013 ; Licensed MIT */

var mpApp=mpApp||{};mpApp["minnpost-medicare-provider-charges"]=mpApp["minnpost-medicare-provider-charges"]||{},function(e,t){e.templates=e.templates||{},e.getTemplate=function(a,i,n){var r="js/templates/"+a+".html";n=n||e,_.isUndefined(e.templates[r])?t.ajax({url:r,method:"GET",async:!1,contentType:"text",success:function(t){e.templates[r]=_.template(t),i.apply(n,[e.templates[r]])}}):i.apply(n,[e.templates[r]])},e.data=e.data||{},e.getData=function(a){var i="http://mp-jsonproxy.herokuapp.com/proxy?callback=?&url=",n=!1,r=[];return a=_.isArray(a)?a:[a],0===e.options.dataPath.indexOf("http")&&(n=!0),_.each(a,function(a){var p;p=n?t.jsonp({url:i+encodeURI(e.options.dataPath+a+".json")}):t.getJSON(e.options.dataPath+a+".json"),r.push(p)}),t.when.apply(t,r)}}(mpApp["minnpost-medicare-provider-charges"],jQuery),this.mpApp=this.mpApp||{},this.mpApp["minnpost-medicare-provider-charges"]=this.mpApp["minnpost-medicare-provider-charges"]||{},this.mpApp["minnpost-medicare-provider-charges"].templates=this.mpApp["minnpost-medicare-provider-charges"].templates||{},this.mpApp["minnpost-medicare-provider-charges"].templates["js/templates/template-container.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="main-container">\n\n  <div class="map-container">\n    <div id="provider-map"></div>\n  </div>\n  \n  <div class="search-container">\n  \n  </div>\n  \n  <div class="results-container">\n  \n  </div>\n\n</div>';return __p},this.mpApp["minnpost-medicare-provider-charges"].templates["js/templates/template-error.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,obj)__p+='<div class="error-container">\n  <div class="error"><span>There was an error.  '+(null==(__t=error?error:"")?"":__t)+"</span></div>\n</div>";return __p},this.mpApp["minnpost-medicare-provider-charges"].templates["js/templates/template-loading.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="loading-general-container">\n  <div class="loading-general"><span>Loading...</span></div>\n</div>';return __p},this.mpApp["minnpost-medicare-provider-charges"].templates["js/templates/template-map-popup.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,obj)__p+='<div class="map-popup">\n  <h3>'+(null==(__t=p.name)?"":__t)+"</h3>\n  \n  "+(null==(__t=p.street)?"":__t)+"<br />\n  "+(null==(__t=p.city)?"":__t)+", "+(null==(__t=p.state)?"":__t)+" "+(null==(__t=p.zip)?"":__t)+"\n</div>";return __p},function(e){e.ProviderModel=Backbone.Model.extend({initialize:function(){this.set("charges",_.where(e.data.charges,{provider:this.id}))}}),e.ProvidersCollection=Backbone.Collection.extend({model:e.ProviderModel,comparator:"name"}),e.AppView=Backbone.View.extend({el:"#minnpost-medicare-provider-charges",mapBaseLayer:new L.TileLayer("http://{s}.tiles.mapbox.com/v3/minnpost.map-wi88b700/{z}/{x}/{y}.png",{attribution:'Map tiles &copy; <a href="http://mapbox.com">MapBox</a>',maxZoom:17}),initialize:function(){this.templates=this.templates||{}},render:function(){return e.getTemplate("template-container",function(e){this.$el.html(e({}))},this),this},renderMap:function(t){var a=this;return this.map=new L.Map("provider-map").setView([46.708,-93.056],6),this.mapBaseLayer.addTo(this.map),t.each(function(t){e.getTemplate("template-map-popup",function(e){L.marker([t.get("lat"),t.get("lng")]).addTo(a.map).bindPopup(e({p:t.toJSON()}))},this)}),this},renderLoading:function(t){return e.getTemplate("template-loading",function(e){this.templates.loading=e,this.$el.html(this.templates.loading({message:t}))},this),this},renderError:function(t){return e.getTemplate("template-error",function(e){this.templates.error=e,this.$el.html(this.templates.error({error:t}))},this),this}}),e.Application=Backbone.Router.extend({routes:{map:"routeMap","*defaultR":"routeDefault"},defaultOptions:{imagePath:"./css/images/",dataPath:"./data/converted/"},dataSets:["charges","drgs","providers","stats"],initialize:function(t){var a=this;e.options=_.extend(this.defaultOptions,t),0===e.options.imagePath.indexOf("http")&&(L.Icon.Default.imagePath=e.options.imagePath.slice(0,-1)),this.mainView=new e.AppView({el:t.el}),this.mainView.renderLoading(),e.getData(this.dataSets).done(function(){e.data.charges=arguments[0][0],e.data.drgs=arguments[1][0],e.data.providers=arguments[2][0],e.data.stats=arguments[3][0],a.processData()}).fail(function(){a.mainView.renderError()})},processData:function(){var t=this;this.providers=new e.ProvidersCollection,_.each(e.data.providers,function(a){t.providers.add(new e.ProviderModel(a))}),this.mainView.render(),this.start()},start:function(){Backbone.history.start()},routeDefault:function(){this.navigate("/map",{trigger:!0,replace:!0})},routeMap:function(){this.mainView.renderMap(this.providers)}})}(mpApp["minnpost-medicare-provider-charges"],jQuery);