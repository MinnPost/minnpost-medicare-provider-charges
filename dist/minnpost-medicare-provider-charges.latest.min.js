/*! minnpost-medicare-provider-charges - v0.0.1 - 2013-05-14
* https://github.com/MinnPost/minnpost-crime
* Copyright (c) 2013 ; Licensed MIT */

var mpApp=mpApp||{};mpApp["minnpost-medicare-provider-charges"]=mpApp["minnpost-medicare-provider-charges"]||{},_.mixin({formatCurrency:function(t){var e=/(\d+)(\d{3})/;for(split=(""+t.toFixed(2)).split(".");e.test(split[0]);)split[0]=split[0].replace(e,"$1,$2");return"$"+split[0]+"."+split[1]},formatPercentage:function(t){return""+(100*t).toFixed(1)+"%"}}),function(t,e){t.templates=t.templates||{},t.getTemplate=function(a,r,i){var n="js/templates/"+a+".html";i=i||t,_.isUndefined(t.templates[n])?e.ajax({url:n,method:"GET",async:!1,contentType:"text",success:function(e){t.templates[n]=_.template(e),r.apply(i,[t.templates[n]])}}):r.apply(i,[t.templates[n]])},t.data=t.data||{},t.getData=function(a){var r="http://mp-jsonproxy.herokuapp.com/proxy?callback=?&url=",i=!1,n=[];return a=_.isArray(a)?a:[a],0===t.options.dataPath.indexOf("http")&&(i=!0),_.each(a,function(a){var s;s=i?e.jsonp({url:r+encodeURI(t.options.dataPath+a+".json")}):e.getJSON(t.options.dataPath+a+".json"),n.push(s)}),e.when.apply(e,n)}}(mpApp["minnpost-medicare-provider-charges"],jQuery),this.mpApp=this.mpApp||{},this.mpApp["minnpost-medicare-provider-charges"]=this.mpApp["minnpost-medicare-provider-charges"]||{},this.mpApp["minnpost-medicare-provider-charges"].templates=this.mpApp["minnpost-medicare-provider-charges"].templates||{},this.mpApp["minnpost-medicare-provider-charges"].templates["js/templates/template-container.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="main-container">\n\n  <div class="map-container">\n    <div id="provider-map"></div>\n  </div>\n  \n  <div class="search-container">\n  \n  </div>\n  \n  <div class="results-container">\n  \n  </div>\n\n</div>';return __p},this.mpApp["minnpost-medicare-provider-charges"].templates["js/templates/template-error.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,obj)__p+='<div class="error-container">\n  <div class="error"><span>There was an error.  '+(null==(__t=error?error:"")?"":__t)+"</span></div>\n</div>";return __p},this.mpApp["minnpost-medicare-provider-charges"].templates["js/templates/template-loading.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="loading-general-container">\n  <div class="loading-general"><span>Loading...</span></div>\n</div>';return __p},this.mpApp["minnpost-medicare-provider-charges"].templates["js/templates/template-map-popup.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,obj)__p+='<div class="map-popup">\n  <h3>'+(null==(__t=p.name)?"":__t)+"</h3>\n  \n  "+(null==(__t=p.street)?"":__t)+"<br />\n  "+(null==(__t=p.city)?"":__t)+", "+(null==(__t=p.state)?"":__t)+" "+(null==(__t=p.zip)?"":__t)+"\n</div>";return __p},this.mpApp["minnpost-medicare-provider-charges"].templates["js/templates/template-provider.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='<div class="providers clear-block">\n  <h3>'+(null==(__t=p?p.name:"")?"":__t)+"</h3>\n  \n  <table>\n    <thead>\n      <tr>\n        <th>Clinical conditions, diagnoses, procedures (number reported)</th>\n        \n        <th>Avg chg</th>\n        <th>Avg payed</th>\n        <th>% payed</th>\n      </tr>\n    </thead>\n    \n    <tbody>\n      ",_.each(_.sortBy(p.charges,function(t){return-1*t.totDischg}),function(t){__p+="\n        <tr>\n          <td>"+(null==(__t=drgs[t.drg])?"":__t)+" ("+(null==(__t=t.totDischg)?"":__t)+")</td>\n          \n          ",_.each(["avgCovChg","avgTotPay","perPay"],function(e){__p+='\n            <td>\n              <div class="box-plot average-coverage-charge" \n                data-median="'+(null==(__t=stats[statPrefix+t.drg][e].median)?"":__t)+'" \n                data-q25="'+(null==(__t=stats[statPrefix+t.drg][e].q25)?"":__t)+'" \n                data-q75="'+(null==(__t=stats[statPrefix+t.drg][e].q75)?"":__t)+'" \n                data-min="'+(null==(__t=stats[statPrefix+t.drg][e].stepL)?"":__t)+'" \n                data-max="'+(null==(__t=stats[statPrefix+t.drg][e].stepU)?"":__t)+'" \n                data-value="'+(null==(__t=t[e])?"":__t)+'" \n                data-axis-max="'+(null==(__t=p["max"+e])?"":__t)+'"></div>\n            </td>\n          '}),__p+="\n        </tr>\n      "}),__p+="\n    </tbody>\n  </table>\n  \n</div>";return __p},function(t,e){t.ProviderModel=Backbone.Model.extend({mapMarkerStyle:{stroke:!1,fillOpacity:.75,fillColor:"#222222",radius:4},mapMarkerHighlight:{stroke:!0,color:"#BCBCBC",fillOpacity:.95,fillColor:"#787878",radius:7},initialize:function(){this.set("charges",_.where(t.data.charges,{provider:this.id})),this.setMaxes()},setMaxes:function(){var t=this;_.each(["avgCovChg","avgTotPay","perPay"],function(e){t.set("max"+e,_.max(t.get("charges"),function(t){return t[e]})[e])}),this.set("maxperPay",1),this.set("maxavgCovChg",13e4>this.get("maxavgCovChg")?13e4:this.get("maxavgCovChg")),this.set("maxavgTotPay",3e4>this.get("maxavgTotPay")?3e4:this.get("maxavgTotPay"))},addMarker:function(e,a){var r=this,i=new L.CircleMarker([this.get("lat"),this.get("lng")],this.mapMarkerStyle);return i.addTo(e).bindPopup(a).on("click",function(){i.setStyle(r.mapMarkerHighlight),t.router.navigate("/provider/"+r.id,{trigger:!0,replace:!0})}).on("mouseover",function(){i.setStyle(r.mapMarkerHighlight)}).on("mouseout",function(){i.setStyle(r.mapMarkerStyle)}),this.set("marker",i),this}}),t.ProvidersCollection=Backbone.Collection.extend({model:t.ProviderModel,comparator:"name"}),t.AppView=Backbone.View.extend({el:"#minnpost-medicare-provider-charges",providerEl:".results-container",mapOptions:{scrollWheelZoom:!1},mapLayers:{Streets:new L.TileLayer("http://{s}.tiles.mapbox.com/v3/minnpost.map-wi88b700/{z}/{x}/{y}.png"),Satellite:new L.TileLayer("http://{s}.tiles.mapbox.com/v3/minnpost.map-95lgm5jf/{z}/{x}/{y}.png")},initialize:function(){this.templates=this.templates||{}},render:function(){return t.getTemplate("template-container",function(t){this.$el.html(t({}))},this),this},renderMap:function(e){var a=this;return this.map=new L.Map("provider-map",this.mapOptions).setView([46.708,-93.056],6),this.map.addLayer(this.mapLayers.Streets),this.map.addControl(new L.control.layers(this.mapLayers)),this.map.attributionControl.setPrefix(!1),e.each(function(e){t.getTemplate("template-map-popup",function(t){e.addMarker(a.map,t({p:e.toJSON()}))},this)}),this},renderProvider:function(a){var r=this;return t.getTemplate("template-provider",function(i){r.$el.find(r.providerEl).html(i({p:_.isObject(a)?a.toJSON():!1,statPrefix:"FL-",drgs:t.data.drgs,stats:t.data.stats})),e(".box-plot").each(function(){r.renderBoxPlot(e(this))})}),this},renderLoading:function(e){return t.getTemplate("template-loading",function(t){this.templates.loading=t,this.$el.html(this.templates.loading({message:e}))},this),this},renderError:function(e){return t.getTemplate("template-error",function(t){this.templates.error=t,this.$el.html(this.templates.error({error:e}))},this),this},renderBoxPlot:function(t){var a=e(t),r=a.width(),i=a.height(),n=a.data(),s=new Raphael(a[0],r,i),o=0,p=25e4,l=.1*i,d=i-2*l;p=n.axisMax?parseFloat(n.axisMax):p,o=n.axisMin?parseFloat(n.axisMin):o;var c=this.scaleValue(o,p,n.min,r),m=this.scaleValue(o,p,n.q25,r),h=this.scaleValue(o,p,n.median,r),u=this.scaleValue(o,p,n.q75,r),_=this.scaleValue(o,p,n.max,r),v=this.scaleValue(o,p,n.value,r);s.rect(c,2*l,1,d-2*l).attr({stroke:"#787878"}),s.rect(_,2*l,1,d-2*l).attr({stroke:"#787878"}),s.rect(c,i/2,m-c,.5).attr({stroke:"#787878"}),s.rect(u,i/2,_-u,.5).attr({stroke:"#787878"}),s.rect(m,l,u-m,d).attr({stroke:"#787878"}),s.rect(h,l,1,d).attr({stroke:"#242424"}),s.rect(v,0,1,i).attr({stroke:"red"})},scaleValue:function(t,e,a,r){return(a-t)/(e-t)*r}}),t.Application=Backbone.Router.extend({routes:{map:"routeMap","provider/:provider":"routeProvider","*defaultR":"routeDefault"},defaultOptions:{imagePath:"./css/images/",dataPath:"./data/converted/"},dataSets:["charges","drgs","providers","stats"],displayProviders:[],initialize:function(e){var a=this;t.router=this,t.options=_.extend(this.defaultOptions,e),0===t.options.imagePath.indexOf("http")&&(L.Icon.Default.imagePath=t.options.imagePath.slice(0,-1)),this.mainView=new t.AppView({el:e.el}),this.mainView.renderLoading(),t.getData(this.dataSets).done(function(){t.data.charges=arguments[0][0],t.data.drgs=arguments[1][0],t.data.providers=arguments[2][0],t.data.stats=arguments[3][0],a.processData()}).fail(function(){a.mainView.renderError()})},processData:function(){var e=this;_.each(t.data.charges,function(e,a){t.data.charges[a].perPay=e.avgTotPay/e.avgCovChg}),this.providers=new t.ProvidersCollection,_.each(t.data.providers,function(a){e.providers.add(new t.ProviderModel(a))}),this.mainView.render(),this.mainView.renderMap(this.providers),this.start()},start:function(){Backbone.history.start()},routeDefault:function(){},routeProvider:function(t){var e=this;e.mainView.renderProvider(this.providers.get(t))}})}(mpApp["minnpost-medicare-provider-charges"],jQuery);