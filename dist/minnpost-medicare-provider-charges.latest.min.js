/*! minnpost-medicare-provider-charges - v0.0.1 - 2013-05-09
* https://github.com/MinnPost/minnpost-crime
* Copyright (c) 2013 ; Licensed MIT */

var mpApp=mpApp||{};mpApp["minnpost-medicare-provider-charges"]=mpApp["minnpost-medicare-provider-charges"]||{},function(e,t){e.templates=e.templates||{},e.getTemplate=function(a,i,r){var n="js/templates/"+a+".html";r=r||e,_.isUndefined(e.templates[n])?t.ajax({url:n,method:"GET",async:!1,contentType:"text",success:function(t){e.templates[n]=_.template(t),i.apply(r,[e.templates[n]])}}):i.apply(r,[e.templates[n]])},e.data=e.data||{},e.getData=function(a){var i="http://mp-jsonproxy.herokuapp.com/proxy?callback=?&url=",r=!1,n=[];return a=_.isArray(a)?a:[a],0===e.options.dataPath.indexOf("http")&&(r=!0),_.each(a,function(a){var o;o=r?t.jsonp({url:i+encodeURI(e.options.dataPath+a+".json")}):t.getJSON(e.options.dataPath+a+".json"),n.push(o)}),t.when.apply(t,n)}}(mpApp["minnpost-medicare-provider-charges"],jQuery),function(e){e.ProviderModel=Backbone.Model.extend({initialize:function(){this.set("charges",_.where(e.data.charges,{provider:this.id}))}}),e.ProvidersCollection=Backbone.Collection.extend({model:e.ProviderModel,comparator:"name"}),e.AppView=Backbone.View.extend({el:"#minnpost-medicare-provider-charges",mapBaseLayer:new L.TileLayer("http://{s}.tiles.mapbox.com/v3/minnpost.map-wi88b700/{z}/{x}/{y}.png",{attribution:'Map tiles &copy; <a href="http://mapbox.com">MapBox</a>',maxZoom:17}),initialize:function(){this.templates=this.templates||{}},render:function(){return e.getTemplate("template-container",function(e){this.$el.html(e({}))},this),this},renderMap:function(t){var a=this;return this.map=new L.Map("provider-map").setView([46.708,-93.056],6),this.mapBaseLayer.addTo(this.map),t.each(function(t){e.getTemplate("template-map-popup",function(e){L.marker([t.get("lat"),t.get("lng")]).addTo(a.map).bindPopup(e({p:t.toJSON()})).openPopup()},this)}),this},renderLoading:function(t){return e.getTemplate("template-loading",function(e){this.templates.loading=e,this.$el.html(this.templates.loading({message:t}))},this),this},renderError:function(t){return e.getTemplate("template-error",function(e){this.templates.error=e,this.$el.html(this.templates.error({error:t}))},this),this}}),e.Application=Backbone.Router.extend({routes:{map:"routeMap","*defaultR":"routeDefault"},defaultOptions:{imagePath:"./css/images/",dataPath:"./data/"},dataSet:["converted/charges","converted/drgs","converted/providers","converted/stats"],initialize:function(t){var a=this;e.options=_.extend(this.defaultOptions,t),this.mainView=new e.AppView({el:t.el}),this.mainView.renderLoading(),e.getData(this.dataSet).done(function(){e.data.charges=arguments[0][0],e.data.drgs=arguments[1][0],e.data.providers=arguments[2][0],e.data.stats=arguments[3][0],a.processData()}).fail(function(){a.mainView.renderError()})},processData:function(){var t=this;this.providers=new e.ProvidersCollection,_.each(e.data.providers,function(a){t.providers.add(new e.ProviderModel(a))}),this.mainView.render(),this.start()},start:function(){Backbone.history.start()},routeDefault:function(){this.navigate("/map",{trigger:!0,replace:!0})},routeMap:function(){this.mainView.renderMap(this.providers)}})}(mpApp["minnpost-medicare-provider-charges"],jQuery);